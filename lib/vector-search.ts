import { createClient } from "@supabase/supabase-js"
import OpenAI from "openai"

const supabase = createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!)

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
})

// ×™×¦×™×¨×ª embedding
export async function createEmbedding(text: string): Promise<number[]> {
  try {
    console.log("ğŸ”„ ×™×•×¦×¨ embedding ×¢×‘×•×¨:", text.substring(0, 100) + "...")

    const response = await openai.embeddings.create({
      model: "text-embedding-ada-002",
      input: text,
    })

    console.log("âœ… Embedding × ×•×¦×¨ ×‘×”×¦×œ×—×”, ××•×¨×š:", response.data[0].embedding.length)
    return response.data[0].embedding
  } catch (error) {
    console.error("âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª embedding:", error)
    throw new Error(`×©×’×™××” ×‘×™×¦×™×¨×ª embedding: ${error instanceof Error ? error.message : "×©×’×™××” ×œ× ×™×“×•×¢×”"}`)
  }
}

// ×—×™×¤×•×© ××¡××›×™× ×“×•××™×
export async function searchSimilarDocuments(
  embedding: number[],
  language: "he" | "en",
  limit = 3,
): Promise<
  Array<{
    plain_text: string
    title: string
    file_name: string
    storage_path: string
    similarity: number
  }>
> {
  try {
    console.log(`ğŸ” ××—×¤×© ××¡××›×™× ×‘×©×¤×”: ${language}, limit: ${limit}`)
    console.log("ğŸ“Š Embedding length:", embedding.length)

    const { data: functions, error: functionsError } = await supabase.rpc("match_documents", {
      query_embedding: embedding,
      match_threshold: 0.8,
      match_count: limit,
      filter_language: language,
    })

    if (functionsError) {
      console.error("âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-RPC match_documents:", functionsError)
      throw new Error(`×©×’×™××” ×‘×—×™×¤×•×© ××¡××›×™×: ${functionsError.message}`)
    }

    console.log(`âœ… × ××¦××• ${functions?.length || 0} ××¡××›×™×`)
    console.log(
      "ğŸ“„ ××¡××›×™× ×©× ××¦××•:",
      functions?.map((doc) => ({
        title: doc.title,
        similarity: doc.similarity,
        storage_path: doc.storage_path,
        text_preview: doc.plain_text?.substring(0, 100) + "...",
      })),
    )

    return functions || []
  } catch (error) {
    console.error("âŒ ×©×’×™××” ×‘×—×™×¤×•×© ××¡××›×™×:", error)
    throw error
  }
}
